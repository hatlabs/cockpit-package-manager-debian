#!/usr/bin/env bash
#
# usage: ./run command [argument ...]
#
# Commands used during development / CI.
#

set -o nounset
set -o pipefail
set -o errexit

# Change the current directory to the project root.
PROJECT_ROOT=${0%/*}
if [[ $0 != $PROJECT_ROOT && $PROJECT_ROOT != "" ]]; then
  cd "$PROJECT_ROOT"
fi
readonly PROJECT_ROOT=$(pwd)

# Store the absolute path to this script (useful for recursion).
readonly SCRIPT="$PROJECT_ROOT/$(basename "$0")"

################################################################################
# Core Commands

function release:version {
  #@ Show current project version
  #@ Category: Core
  # Extract version from debian/changelog
  dpkg-parsechangelog -S Version | cut -d- -f1
}

################################################################################
# Setup Commands

function setup:check {
  #@ Check if source directory symlink exists
  #@ Category: Setup
  if [ ! -L "cockpit-package-manager" ]; then
    echo "‚ùå cockpit-package-manager symlink not found"
    echo "   The symlink should point to ../cockpit-package-manager"
    echo "   Run: ln -s ../cockpit-package-manager cockpit-package-manager"
    return 1
  fi

  if [ ! -d "cockpit-package-manager" ]; then
    echo "‚ùå cockpit-package-manager source directory not found"
    echo "   Make sure ../cockpit-package-manager exists"
    return 1
  fi

  echo "‚úÖ Source directory link is valid"
  return 0
}

################################################################################
# Package Management Commands

function package:deb {
  #@ Build Debian package (same as package:deb:docker)
  #@ Category: Package Management
  package:deb:docker
}

function package:deb:docker {
  #@ Build Debian package using Docker container
  #@ Category: Package Management

  setup:check

  echo "üê≥ Building Debian package using Docker..."

  docker compose -f docker/docker-compose.debtools.yml run --rm debtools dpkg-buildpackage -us -uc -b

  echo "‚úÖ Docker-based Debian package built successfully"
  echo ""
  echo "Package file(s):"
  ls -lh ../*.deb 2>/dev/null || echo "  No .deb files found in parent directory"
}

function package:deb:docker:ci {
  #@ Build Debian package for CI (same as package:deb:docker)
  #@ Category: Package Management
  package:deb:docker
}

function package:inspect {
  #@ List contents of built package
  #@ Category: Package Management
  local deb_file=$(ls ../cockpit-package-manager_*.deb 2>/dev/null | head -1)
  if [ -z "$deb_file" ]; then
    echo "‚ùå No .deb file found. Build package first with: ./run package:deb:docker"
    return 1
  fi

  echo "üì¶ Package contents:"
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools \
    dpkg-deb --contents "$deb_file"
}

function package:info {
  #@ Show package metadata
  #@ Category: Package Management
  local deb_file=$(ls ../cockpit-package-manager_*.deb 2>/dev/null | head -1)
  if [ -z "$deb_file" ]; then
    echo "‚ùå No .deb file found. Build package first with: ./run package:deb:docker"
    return 1
  fi

  echo "‚ÑπÔ∏è  Package information:"
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools \
    dpkg-deb --info "$deb_file"
}

function package:extract {
  #@ Extract package to /tmp for inspection
  #@ Category: Package Management
  local deb_file=$(ls ../cockpit-package-manager_*.deb 2>/dev/null | head -1)
  if [ -z "$deb_file" ]; then
    echo "‚ùå No .deb file found. Build package first with: ./run package:deb:docker"
    return 1
  fi

  local deb_basename=$(basename "$deb_file")

  echo "üìÇ Extracting package to /tmp/cockpit-package-manager-extract..."
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools bash -c \
    "rm -rf /tmp/cockpit-package-manager-extract && \
     mkdir -p /tmp/cockpit-package-manager-extract && \
     dpkg-deb --extract /workspace/$deb_basename /tmp/cockpit-package-manager-extract && \
     ls -lah /tmp/cockpit-package-manager-extract/usr/share/cockpit/packagemanager/"
}

function debtools:shell {
  #@ Open interactive shell in debtools container
  #@ Category: Development
  echo "üêö Opening shell in debtools container..."
  echo "   Working directory: /workspace/cockpit-package-manager-debian"
  echo "   Exit with: exit or Ctrl+D"
  echo ""
  docker compose -f docker/docker-compose.debtools.yml run --rm debtools bash
}

function package:docker:build {
  #@ Build Docker tools image
  #@ Category: Package Management
  docker compose -f docker/docker-compose.debtools.yml build debtools "$@"
}

function package:clean {
  #@ Clean build artifacts
  #@ Category: Package Management
  echo "üßπ Cleaning build artifacts..."

  rm -rf debian/.debhelper/
  rm -rf debian/cockpit-package-manager/
  rm -f debian/files
  rm -f debian/debhelper-build-stamp
  rm -f debian/*.log
  rm -f debian/*.substvars
  rm -rf debian/tmp/

  # Clean built packages
  rm -f ../*.deb
  rm -f ../*.buildinfo
  rm -f ../*.changes

  # Clean source build artifacts if present
  if [ -d "cockpit-package-manager" ]; then
    cd cockpit-package-manager
    rm -rf node_modules/
    rm -f packagemanager/packagemanager.js
    rm -f packagemanager/packagemanager.js.map
    rm -f packagemanager/packagemanager.css
    rm -f packagemanager/packagemanager.css.map
    cd ..
  fi

  echo "‚úÖ Cleanup complete"
}

################################################################################
# Help System

function help {
  #@ Show this help message
  #@ Category: Core
  echo "Cockpit Package Manager - Debian Packaging"
  echo "==========================================="
  echo ""
  echo "Available commands:"
  echo ""

  # Extract function definitions and their help comments
  awk '/^function / {
    fname = $2
    sub(/[({].*/, "", fname)
    getline
    if ($0 ~ /#@/) {
      desc = $0
      sub(/.*#@ /, "", desc)
      sub(/ *$/, "", desc)
      getline
      if ($0 ~ /#@ Category:/) {
        cat = $0
        sub(/.*Category: /, "", cat)
        sub(/ *$/, "", cat)
        if (!seen[cat]++) categories[++cat_count] = cat
        commands[cat, ++cmd_count[cat]] = fname
        descriptions[cat, cmd_count[cat]] = desc
      }
    }
  }
  END {
    for (i = 1; i <= cat_count; i++) {
      cat = categories[i]
      print "\n" cat ":"
      for (j = 1; j <= cmd_count[cat]; j++) {
        printf "  %-30s %s\n", commands[cat, j], descriptions[cat, j]
      }
    }
  }' "$0"

  echo ""
  echo "Usage: ./run <command> [arguments...]"
  echo ""
  echo "Quick start:"
  echo "  1. ./run setup:check           # Verify source directory link"
  echo "  2. ./run package:deb:docker    # Build package in Docker"
  echo "  3. ./run package:inspect       # List package contents"
  echo "  4. ./run package:clean         # Clean build artifacts"
  echo ""
  echo "Inspection:"
  echo "  ./run package:info             # Show package metadata"
  echo "  ./run package:extract          # Extract package to /tmp"
  echo "  ./run debtools:shell           # Open shell in container"
}

################################################################################
# Commands end.

TIMEFORMAT=$'\nTask completed in %3lR'
time "${@:-help}"
